// Language translations
const translations = {
    en: {
        appTitle: 'Finance Manager',
        totalBalance: 'Total Balance',
        income: 'Income',
        expense: 'Expense',
        recentTransactions: 'Recent Transactions',
        categories: 'Categories',
        reports: 'Reports',
        daily: 'Daily',
        weekly: 'Weekly',
        monthly: 'Monthly',
        annual: 'Annual',
        home: 'Home',
        settings: 'Settings',
        addTransaction: 'Add Transaction',
        type: 'Type',
        amount: 'Amount',
        category: 'Category',
        date: 'Date',
        description: 'Description',
        cancel: 'Cancel',
        save: 'Save',
        close: 'Close',
        reportDetails: 'Report Details',
        addCategory: 'Add Category',
        deleteCategory: 'Delete Category',
        editCategory: 'Edit Category',
        categoryName: 'Category Name',
        categoryIcon: 'Category Icon',
        noTransactions: 'No transactions yet',
        totalIncome: 'Total Income',
        totalExpense: 'Total Expense',
        period: 'Period',
        currency: 'Currency',
        language: 'Language',
        theme: 'Theme',
        dark: 'Dark',
        light: 'Light',
        export: 'Export Data',
        import: 'Import Data',
        cantDeleteCategory: 'Cannot delete category with existing transactions',
        confirmDeleteCategory: 'Are you sure you want to delete this category?',
        importSuccess: 'Data imported successfully',
        importError: 'Error importing data. Please check the file format.',
        newCategory: 'New Category',
        selectIcon: 'Select Icon',
        confirmDelete: 'Are you sure?',
        yes: 'Yes',
        no: 'No',
        today: 'Today',
        yesterday: 'Yesterday',
        thisWeek: 'This Week',
        thisMonth: 'This Month',
        thisYear: 'This Year',
        custom: 'Custom',
        dateRange: 'Date Range',
        from: 'From',
        to: 'To',
        apply: 'Apply',
        reset: 'Reset',
        noData: 'No data for selected period',
        total: 'Total',
        balance: 'Balance',
        transactions: 'Transactions',
        warning: 'Warning',
        notFound: 'not found'
    },
    de: {
        appTitle: 'Finanzmanager',
        totalBalance: 'Gesamtbilanz',
        income: 'Einnahmen',
        expense: 'Ausgaben',
        recentTransactions: 'Letzte Transaktionen',
        categories: 'Kategorien',
        reports: 'Berichte',
        daily: 'Täglich',
        weekly: 'Wöchentlich',
        monthly: 'Monatlich',
        annual: 'Jährlich',
        home: 'Startseite',
        settings: 'Einstellungen',
        addTransaction: 'Transaktion hinzufügen',
        type: 'Typ',
        amount: 'Betrag',
        category: 'Kategorie',
        date: 'Datum',
        description: 'Beschreibung',
        cancel: 'Abbrechen',
        save: 'Speichern',
        close: 'Schließen',
        reportDetails: 'Berichtsdetails',
        addCategory: 'Kategorie hinzufügen',
        deleteCategory: 'Kategorie löschen',
        editCategory: 'Kategorie bearbeiten',
        categoryName: 'Kategoriename',
        categoryIcon: 'Kategorie-Icon',
        noTransactions: 'Noch keine Transaktionen',
        totalIncome: 'Gesamteinnahmen',
        totalExpense: 'Gesamtausgaben',
        period: 'Zeitraum',
        currency: 'Währung',
        language: 'Sprache',
        theme: 'Design',
        dark: 'Dunkel',
        light: 'Hell',
        export: 'Daten exportieren',
        import: 'Daten importieren',
        cantDeleteCategory: 'Kategorie mit vorhandenen Transaktionen kann nicht gelöscht werden',
        confirmDeleteCategory: 'Möchten Sie diese Kategorie wirklich löschen?',
        importSuccess: 'Daten erfolgreich importiert',
        importError: 'Fehler beim Importieren der Daten. Bitte überprüfen Sie das Dateiformat.',
        newCategory: 'Neue Kategorie',
        selectIcon: 'Symbol auswählen',
        confirmDelete: 'Sind Sie sicher?',
        yes: 'Ja',
        no: 'Nein',
        today: 'Heute',
        yesterday: 'Gestern',
        thisWeek: 'Diese Woche',
        thisMonth: 'Dieser Monat',
        thisYear: 'Dieses Jahr',
        custom: 'Benutzerdefiniert',
        dateRange: 'Datumsbereich',
        from: 'Von',
        to: 'Bis',
        apply: 'Anwenden',
        reset: 'Zurücksetzen',
        noData: 'Keine Daten für den ausgewählten Zeitraum',
        total: 'Gesamt',
        balance: 'Bilanz',
        transactions: 'Transaktionen',
        warning: 'Warnung',
        notFound: 'nicht gefunden'
    },
    ru: {
        appTitle: 'Финансовый менеджер',
        totalBalance: 'Общий баланс',
        income: 'Доходы',
        expense: 'Расходы',
        recentTransactions: 'Последние операции',
        categories: 'Категории',
        reports: 'Отчеты',
        daily: 'Ежедневно',
        weekly: 'Еженедельно',
        monthly: 'Ежемесячно',
        annual: 'Ежегодно',
        home: 'Главная',
        settings: 'Настройки',
        addTransaction: 'Добавить операцию',
        type: 'Тип',
        amount: 'Сумма',
        category: 'Категория',
        date: 'Дата',
        description: 'Описание',
        cancel: 'Отмена',
        save: 'Сохранить',
        close: 'Закрыть',
        reportDetails: 'Детали отчета',
        addCategory: 'Добавить категорию',
        deleteCategory: 'Удалить категорию',
        editCategory: 'Редактировать категорию',
        categoryName: 'Название категории',
        categoryIcon: 'Иконка категории',
        noTransactions: 'Пока нет операций',
        totalIncome: 'Общий доход',
        totalExpense: 'Общие расходы',
        period: 'Период',
        currency: 'Валюта',
        language: 'Язык',
        theme: 'Тема',
        dark: 'Темная',
        light: 'Светлая',
        export: 'Экспорт данных',
        import: 'Импорт данных',
        cantDeleteCategory: 'Невозможно удалить категорию с существующими операциями',
        confirmDeleteCategory: 'Вы уверены, что хотите удалить эту категорию?',
        importSuccess: 'Данные успешно импортированы',
        importError: 'Ошибка при импорте данных. Пожалуйста, проверьте формат файла.',
        newCategory: 'Новая категория',
        selectIcon: 'Выберите иконку',
        confirmDelete: 'Вы уверены?',
        yes: 'Да',
        no: 'Нет',
        today: 'Сегодня',
        yesterday: 'Вчера',
        thisWeek: 'Эта неделя',
        thisMonth: 'Этот месяц',
        thisYear: 'Этот год',
        custom: 'Произвольный',
        dateRange: 'Период',
        from: 'С',
        to: 'По',
        apply: 'Применить',
        reset: 'Сбросить',
        noData: 'Нет данных за выбранный период',
        total: 'Итого',
        balance: 'Баланс',
        transactions: 'Операции',
        warning: 'Предупреждение',
        notFound: 'не найдена'
    }
};

// Default categories with translations
const defaultCategories = {
    income: [
        { id: 'salary', name: { en: 'Salary', de: 'Gehalt', ru: 'Зарплата' }, icon: 'fa-wallet' },
        { id: 'gifts', name: { en: 'Gifts', de: 'Geschenke', ru: 'Подарки' }, icon: 'fa-gift' },
        { id: 'investments', name: { en: 'Investments', de: 'Investitionen', ru: 'Инвестиции' }, icon: 'fa-chart-line' },
        { id: 'freelance', name: { en: 'Freelance', de: 'Freiberuflich', ru: 'Фриланс' }, icon: 'fa-laptop' },
        { id: 'business', name: { en: 'Business', de: 'Geschäft', ru: 'Бизнес' }, icon: 'fa-briefcase' },
        { id: 'rental', name: { en: 'Rental', de: 'Vermietung', ru: 'Аренда' }, icon: 'fa-building' },
        { id: 'dividends', name: { en: 'Dividends', de: 'Dividenden', ru: 'Дивиденды' }, icon: 'fa-money-bill' },
        { id: 'royalties', name: { en: 'Royalties', de: 'Lizenzgebühren', ru: 'Роялти' }, icon: 'fa-crown' },
        { id: 'pension', name: { en: 'Pension', de: 'Rente', ru: 'Пенсия' }, icon: 'fa-hand-holding-usd' },
        { id: 'other_income', name: { en: 'Other', de: 'Sonstiges', ru: 'Другое' }, icon: 'fa-ellipsis-h' }
    ],
    expense: [
        { id: 'groceries', name: { en: 'Groceries', de: 'Lebensmittel', ru: 'Продукты' }, icon: 'fa-shopping-cart' },
        { id: 'housing', name: { en: 'Housing', de: 'Wohnen', ru: 'Жилье' }, icon: 'fa-home' },
        { id: 'transport', name: { en: 'Transport', de: 'Transport', ru: 'Транспорт' }, icon: 'fa-car' },
        { id: 'food', name: { en: 'Food', de: 'Essen', ru: 'Еда' }, icon: 'fa-utensils' },
        { id: 'utilities', name: { en: 'Utilities', de: 'Versorgungsunternehmen', ru: 'Коммунальные услуги' }, icon: 'fa-bolt' },
        { id: 'entertainment', name: { en: 'Entertainment', de: 'Unterhaltung', ru: 'Развлечения' }, icon: 'fa-film' },
        { id: 'beauty', name: { en: 'Beauty', de: 'Schönheit', ru: 'Красота' }, icon: 'fa-spa' },
        { id: 'cinema', name: { en: 'Cinema', de: 'Kino', ru: 'Кино' }, icon: 'fa-film' },
        { id: 'other_expense', name: { en: 'Other', de: 'Sonstiges', ru: 'Другое' }, icon: 'fa-ellipsis-h' }
    ]
};

// Application state
let currentLang = localStorage.getItem('currentLang') || 'en';
let transactions = [];
let categories = JSON.parse(localStorage.getItem('categories')) || { ...defaultCategories };
let currentCurrency = localStorage.getItem('currentCurrency') || '$';
let currentTheme = localStorage.getItem('theme') || 'dark';

// DOM Elements
const modal = document.getElementById('transactionModal');
const reportModal = document.getElementById('reportModal');
const transactionForm = document.getElementById('transactionForm');
const langButtons = document.querySelectorAll('.lang-btn');
const incomeBtn = document.querySelector('.income-btn');
const expenseBtn = document.querySelector('.expense-btn');
const cancelBtns = document.querySelectorAll('.cancel-btn');
const transactionsList = document.querySelector('.transactions-list');
const amountDisplay = document.querySelector('.amount');
const categoriesGrid = document.querySelector('.categories-grid');
const reportCards = document.querySelectorAll('.report-card');
const settingsBtn = document.querySelector('.nav-btn:last-child');

// Event Listeners
function initializeEventListeners() {
    langButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const lang = btn.dataset.lang;
            setLanguage(lang);
        });
    });

    incomeBtn.addEventListener('click', () => showTransactionModal('income'));
    expenseBtn.addEventListener('click', () => showTransactionModal('expense'));
    
    cancelBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            hideModal(btn.closest('.modal'));
        });
    });

    transactionForm.addEventListener('submit', handleTransactionSubmit);

    // Обновляем обработчики для кнопок навигации
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const section = btn.dataset.section;
            if (section === 'home') {
                showHome();
            } else if (section === 'reports') {
                showReports();
            } else if (section === 'settings') {
                showSettings();
            }
        });
    });

    settingsBtn.addEventListener('click', showSettings);

    // Добавляем обработчик для закрытия модальных окон по клику вне их области
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            hideModal(e.target);
        }
    });
}

// Functions
function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('currentLang', lang);
    
    // Update active state of language buttons
    langButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    
    // Update all translatable elements
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.dataset.translate;
        element.textContent = translations[lang][key] || key;
    });

    // Update dynamic content
    updateTransactionsList();
    updateCategoryOptions('income');
    updateCategoryOptions('expense');
    renderCategories();
    updateBalance();
}

function hideModal(modalElement) {
    modalElement.classList.remove('active');
    if (modalElement === modal) {
        transactionForm.reset();
    }
}

function editCategory(category) {
    // Предотвращаем всплытие события
    event.stopPropagation();
    
    const modalHTML = `
        <div class="modal category-modal active">
            <div class="modal-content">
                <h2>${translations[currentLang].editCategory}</h2>
                <form id="categoryForm">
                    <div class="form-group">
                        <label>${translations[currentLang].categoryName}</label>
                        <input type="text" name="name_en" placeholder="English name" value="${category.name.en}" required>
                        <input type="text" name="name_de" placeholder="German name" value="${category.name.de}" required>
                        <input type="text" name="name_ru" placeholder="Russian name" value="${category.name.ru}" required>
                    </div>
                    <div class="form-group">
                        <label>${translations[currentLang].categoryIcon}</label>
                        <select name="icon" required>
                            ${generateIconOptions(category.icon)}
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn">${translations[currentLang].cancel}</button>
                        <button type="submit" class="save-btn">${translations[currentLang].save}</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const categoryModal = document.querySelector('.category-modal');
    const categoryForm = document.getElementById('categoryForm');

    categoryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(categoryForm);
        
        const updatedCategory = {
            ...category,
            name: {
                en: formData.get('name_en'),
                de: formData.get('name_de'),
                ru: formData.get('name_ru')
            },
            icon: formData.get('icon')
        };

        const categoryType = category.id === 'salary' || category.id === 'gifts' || category.id === 'investments' ? 'income' : 'expense';
        const categoryIndex = categories[categoryType].findIndex(c => c.id === category.id);
        categories[categoryType][categoryIndex] = updatedCategory;

        saveCategories();
        updateCategories();
        updateTransactionsList();
        categoryModal.remove();
    });

    categoryModal.querySelector('.cancel-btn').addEventListener('click', () => {
        categoryModal.remove();
    });
}

function deleteCategory(categoryId) {
    // Предотвращаем всплытие события
    event.stopPropagation();
    
    const categoryType = categories.income.find(c => c.id === categoryId) ? 'income' : 'expense';
    
    // Проверяем, есть ли транзакции с этой категорией
    const hasTransactions = transactions.some(t => t.category === categoryId);
    
    if (hasTransactions) {
        alert(translations[currentLang].cantDeleteCategory);
        return;
    }

    if (confirm(translations[currentLang].confirmDeleteCategory)) {
        categories[categoryType] = categories[categoryType].filter(c => c.id !== categoryId);
        saveCategories();
        updateCategories();
    }
}

function generateIconOptions(selectedIcon) {
    const icons = [
        'fa-wallet', 'fa-gift', 'fa-chart-line', 'fa-shopping-cart', 'fa-home',
        'fa-car', 'fa-utensils', 'fa-bolt', 'fa-film', 'fa-plane', 'fa-gamepad',
        'fa-shopping-bag', 'fa-coffee', 'fa-book', 'fa-music'
    ];

    return icons.map(icon => `
        <option value="${icon}" ${icon === selectedIcon ? 'selected' : ''}>
            <i class="fas ${icon}"></i> ${icon.replace('fa-', '')}
        </option>
    `).join('');
}

function showSettings() {
    // Удаляем существующее модальное окно настроек, если оно есть
    const existingModal = document.querySelector('.settings-modal');
    if (existingModal) {
        existingModal.remove();
    }

    const modalHTML = `
        <div class="modal settings-modal">
            <div class="modal-content">
                <h2>${translations[currentLang].settings}</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>${translations[currentLang].currency}</label>
                        <select name="currency">
                            <option value="$" ${currentCurrency === '$' ? 'selected' : ''}>USD ($)</option>
                            <option value="€" ${currentCurrency === '€' ? 'selected' : ''}>EUR (€)</option>
                            <option value="₽" ${currentCurrency === '₽' ? 'selected' : ''}>RUB (₽)</option>
                            <option value="£" ${currentCurrency === '£' ? 'selected' : ''}>GBP (£)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>${translations[currentLang].theme}</label>
                        <select name="theme">
                            <option value="dark" ${currentTheme === 'dark' ? 'selected' : ''}>${translations[currentLang].dark}</option>
                            <option value="light" ${currentTheme === 'light' ? 'selected' : ''}>${translations[currentLang].light}</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="export-btn">${translations[currentLang].export}</button>
                        <label class="import-btn">
                            ${translations[currentLang].import}
                            <input type="file" accept=".json" style="display: none;">
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn">${translations[currentLang].cancel}</button>
                        <button type="submit" class="save-btn">${translations[currentLang].save}</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const settingsModal = document.querySelector('.settings-modal');
    const settingsForm = document.getElementById('settingsForm');

    function closeModal() {
        if (settingsModal && settingsModal.parentNode) {
            settingsModal.remove();
        }
    }

    // Добавляем обработчики для экспорта/импорта
    const exportBtn = settingsModal.querySelector('.export-btn');
    const importInput = settingsModal.querySelector('input[type="file"]');
    const cancelBtn = settingsModal.querySelector('.cancel-btn');

    exportBtn.addEventListener('click', exportData);
    importInput.addEventListener('change', importData);
    cancelBtn.addEventListener('click', closeModal);

    settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(settingsForm);
        
        currentCurrency = formData.get('currency');
        currentTheme = formData.get('theme');
        
        localStorage.setItem('currentCurrency', currentCurrency);
        localStorage.setItem('theme', currentTheme);
        
        updateUI();
        updateTransactionsList();
        updateBalance();
        applyTheme();
        
        closeModal();
    });

    // Добавляем обработчик клика по фону модального окна
    settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
            closeModal();
        }
    });

    // Показываем модальное окно после того, как все обработчики установлены
    requestAnimationFrame(() => {
        settingsModal.classList.add('active');
    });
}

function exportData() {
    const data = {
        transactions,
        categories,
        settings: {
            currency: currentCurrency,
            language: currentLang,
            theme: currentTheme
        }
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'finance_manager_backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importData(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                transactions = data.transactions;
                categories = data.categories;
                currentCurrency = data.settings.currency;
                currentTheme = data.settings.theme;
                setLanguage(data.settings.language);

                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('currentCurrency', currentCurrency);
                localStorage.setItem('theme', currentTheme);

                updateUI();
                updateCategories();
                updateTransactionsList();
                updateBalance();
                applyTheme();

                alert(translations[currentLang].importSuccess);
            } catch (error) {
                alert(translations[currentLang].importError);
            }
        };
        reader.readAsText(file);
    }
}

function applyTheme() {
    document.body.classList.toggle('light-theme', currentTheme === 'light');
}

function saveCategories() {
    localStorage.setItem('categories', JSON.stringify(categories));
}

function showTransactionModal(type, categoryId = null) {
    modal.classList.add('active');
    const typeSelect = transactionForm.querySelector('select[name="type"]');
    const categorySelect = transactionForm.querySelector('select[name="category"]');
    
    // Устанавливаем тип транзакции
    typeSelect.value = type;
    
    // Добавляем слушатель на изменение типа
    typeSelect.addEventListener('change', (e) => {
        updateCategoryOptions(e.target.value);
    });
    
    // Обновляем список категорий
    updateCategoryOptions(type);
    
    // Если указана категория, выбираем её
    if (categoryId) {
        categorySelect.value = categoryId;
    }
}

function hideTransactionModal() {
    modal.classList.remove('active');
    transactionForm.reset();
}

function updateCategoryOptions(type) {
    console.log('Updating category options for type:', type);
    const categorySelect = transactionForm.querySelector('select[name="category"]');
    categorySelect.innerHTML = '';
    
    if (!categories[type]) {
        console.error('Invalid transaction type:', type);
        return;
    }
    
    categories[type].forEach(category => {
        console.log('Adding category option:', category);
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name[currentLang];
        categorySelect.appendChild(option);
    });
    
    // Выбираем первую категорию по умолчанию
    if (categorySelect.options.length > 0) {
        categorySelect.selectedIndex = 0;
    }
}

function handleTransactionSubmit(e) {
    e.preventDefault();
    console.log('Submitting transaction form...');
    
    const formData = new FormData(transactionForm);
    const type = formData.get('type');
    const category = formData.get('category');
    
    console.log('Transaction type:', type);
    console.log('Selected category:', category);
    
    // Проверяем существование категории перед добавлением
    const categoryExists = categories[type]?.some(c => c.id === category);
    if (!categoryExists) {
        console.error('Category not found:', category, 'for type:', type);
        alert(translations[currentLang].warning + ': ' + 
              (type === 'income' ? translations[currentLang].income : translations[currentLang].expense) + 
              ' - ' + translations[currentLang].category + ' ' + category + ' ' + 
              translations[currentLang].notFound);
        return;
    }
    
    const transaction = {
        id: Date.now(),
        type: type,
        amount: parseFloat(formData.get('amount')),
        category: category,
        date: formData.get('date'),
        description: formData.get('description') || ''
    };
    
    console.log('New transaction data:', transaction);
    console.log('Current transactions before adding:', transactions);
    
    transactions.push(transaction);
    console.log('Transactions after adding:', transactions);
    
    saveTransactions();
    updateTransactionsList();
    updateBalance();
    hideTransactionModal();
}

function updateTransactionsList() {
    console.log('Updating transactions list...');
    console.log('Current transactions:', transactions);
    
    transactionsList.innerHTML = '';
    const recentTransactions = [...transactions] // Создаем копию массива
        .sort((a, b) => b.id - a.id) // Сортируем по ID (timestamp) вместо даты
        .slice(0, 5);

    console.log('Recent transactions to display:', recentTransactions);

    if (recentTransactions.length === 0) {
        console.log('No transactions to display');
        transactionsList.innerHTML = `<div class="no-transactions">${translations[currentLang].noTransactions}</div>`;
        return;
    }

    recentTransactions.forEach(transaction => {
        console.log('Processing transaction:', transaction);
        // Ищем категорию в соответствующем типе транзакции
        const category = categories[transaction.type]?.find(c => c.id === transaction.category);
        console.log('Found category:', category);
        
        // Если категория не найдена, используем запасной вариант
        const fallbackCategory = {
            name: { [currentLang]: transaction.category },
            icon: 'fa-question-circle'
        };
        
        const categoryToUse = category || fallbackCategory;
        
        const transactionElement = document.createElement('div');
        transactionElement.className = `transaction ${transaction.type}`;
        transactionElement.innerHTML = `
            <div class="transaction-icon">
                <i class="fas ${categoryToUse.icon}"></i>
            </div>
            <div class="transaction-details">
                <div class="transaction-category">${categoryToUse.name[currentLang]}</div>
                <div class="transaction-date">${formatDate(transaction.date)}</div>
                ${transaction.description ? `<div class="transaction-description">${transaction.description}</div>` : ''}
            </div>
            <div class="transaction-amount ${transaction.type}">
                ${transaction.type === 'income' ? '+' : '-'}${currentCurrency}${transaction.amount.toFixed(2)}
            </div>
            <div class="transaction-actions">
                <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        transactionsList.appendChild(transactionElement);
    });
    
    console.log('Transactions list updated');
}

function updateBalance() {
    console.log('Updating balance...');
    console.log('Current transactions for balance calculation:', transactions);
    
    const total = transactions.reduce((sum, transaction) => {
        const amount = transaction.type === 'income' ? transaction.amount : -transaction.amount;
        console.log(`Processing transaction: ${transaction.type}, amount: ${amount}`);
        return sum + amount;
    }, 0);
    
    console.log('Calculated total:', total);
    amountDisplay.textContent = `${currentCurrency}${total.toFixed(2)}`;
    console.log('Balance display updated');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(currentLang, {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function showReport(type) {
    const reportData = generateReport(type);
    const reportModal = document.getElementById('reportModal');
    const reportContent = reportModal.querySelector('.report-content');
    
    // Добавляем кнопку закрытия
    reportContent.innerHTML = `
        <div class="report-header">
            <h2>${translations[currentLang][type]}</h2>
            <button class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="report-summary">
            <div class="report-period">${formatReportPeriod(type)}</div>
            <div class="report-totals">
                <div class="total-income">
                    <i class="fas fa-arrow-up"></i>
                    <div class="total-label">${translations[currentLang].totalIncome}</div>
                    <div class="total-amount">+${currentCurrency}${reportData.totalIncome.toFixed(2)}</div>
                </div>
                <div class="total-expense">
                    <i class="fas fa-arrow-down"></i>
                    <div class="total-label">${translations[currentLang].totalExpense}</div>
                    <div class="total-amount">-${currentCurrency}${reportData.totalExpense.toFixed(2)}</div>
                </div>
                <div class="total-balance">
                    <i class="fas fa-balance-scale"></i>
                    <div class="total-label">${translations[currentLang].balance}</div>
                    <div class="total-amount">${currentCurrency}${(reportData.totalIncome - reportData.totalExpense).toFixed(2)}</div>
                </div>
            </div>
        </div>
        <div class="report-categories">
            ${generateCategoriesHTML(reportData)}
        </div>
    `;

    // Добавляем обработчик для закрытия
    const closeBtn = reportContent.querySelector('.close-btn');
    closeBtn.addEventListener('click', () => {
        reportModal.classList.remove('active');
    });
    
    reportModal.classList.add('active');

    // Добавляем обработчик клика вне модального окна
    reportModal.addEventListener('click', (e) => {
        if (e.target === reportModal) {
            reportModal.classList.remove('active');
        }
    });
}

function generateReport(type) {
    const now = new Date();
    let startDate = new Date();
    
    switch(type) {
        case 'daily':
            startDate.setHours(0, 0, 0, 0);
            break;
        case 'weekly':
            startDate.setDate(now.getDate() - 7);
            break;
        case 'monthly':
            startDate.setMonth(now.getMonth() - 1);
            break;
        case 'annual':
            startDate.setFullYear(now.getFullYear() - 1);
            break;
    }
    
    const periodTransactions = transactions.filter(t => {
        const transactionDate = new Date(t.date);
        return transactionDate >= startDate && transactionDate <= now;
    });
    
    const totalIncome = periodTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
        
    const totalExpense = periodTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    return {
        totalIncome,
        totalExpense,
        categories: generateCategoryStats(periodTransactions)
    };
}

function generateCategoryStats(periodTransactions) {
    const stats = {};
    
    // Обработка доходов
    categories.income.forEach(category => {
        const transactions = periodTransactions.filter(t => 
            t.type === 'income' && t.category === category.id
        );
        if (transactions.length > 0) {
            stats[category.id] = {
                name: category.name[currentLang],
                amount: transactions.reduce((sum, t) => sum + t.amount, 0),
                type: 'income',
                icon: category.icon
            };
        }
    });
    
    // Обработка расходов
    categories.expense.forEach(category => {
        const transactions = periodTransactions.filter(t => 
            t.type === 'expense' && t.category === category.id
        );
        if (transactions.length > 0) {
            stats[category.id] = {
                name: category.name[currentLang],
                amount: transactions.reduce((sum, t) => sum + t.amount, 0),
                type: 'expense',
                icon: category.icon
            };
        }
    });
    
    return stats;
}

function formatReportPeriod(type) {
    const now = new Date();
    const dateFormatOptions = {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    };

    switch(type) {
        case 'daily':
            return now.toLocaleDateString(currentLang, dateFormatOptions);
        case 'weekly': {
            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 7);
            return `${weekAgo.toLocaleDateString(currentLang, dateFormatOptions)} - ${now.toLocaleDateString(currentLang, dateFormatOptions)}`;
        }
        case 'monthly': {
            const monthAgo = new Date(now);
            monthAgo.setMonth(now.getMonth() - 1);
            return `${monthAgo.toLocaleDateString(currentLang, dateFormatOptions)} - ${now.toLocaleDateString(currentLang, dateFormatOptions)}`;
        }
        case 'annual': {
            const yearAgo = new Date(now);
            yearAgo.setFullYear(now.getFullYear() - 1);
            return `${yearAgo.toLocaleDateString(currentLang, dateFormatOptions)} - ${now.toLocaleDateString(currentLang, dateFormatOptions)}`;
        }
        default:
            return '';
    }
}

function generateCategoriesHTML(reportData) {
    if (!reportData.categories || Object.keys(reportData.categories).length === 0) {
        return `<div class="no-data">${translations[currentLang].noData}</div>`;
    }

    let incomeHtml = '<div class="category-group income"><h3>' + translations[currentLang].income + '</h3>';
    let expenseHtml = '<div class="category-group expense"><h3>' + translations[currentLang].expense + '</h3>';
    
    for (const [categoryId, data] of Object.entries(reportData.categories)) {
        const categoryHtml = `
            <div class="category-stat ${data.type}">
                <div class="category-icon">
                    <i class="fas ${data.icon}"></i>
                </div>
                <div class="category-info">
                    <div class="category-name">${data.name}</div>
                    <div class="category-amount">${currentCurrency}${data.amount.toFixed(2)}</div>
                </div>
            </div>
        `;
        
        if (data.type === 'income') {
            incomeHtml += categoryHtml;
        } else {
            expenseHtml += categoryHtml;
        }
    }
    
    incomeHtml += '</div>';
    expenseHtml += '</div>';
    
    return incomeHtml + expenseHtml;
}

// Local Storage functions
function saveTransactions() {
    console.log('Saving transactions to localStorage...');
    console.log('Data to save:', transactions);
    
    try {
        localStorage.setItem('transactions', JSON.stringify(transactions));
        console.log('Transactions saved successfully');
    } catch (error) {
        console.error('Error saving transactions:', error);
    }
}

function loadTransactions() {
    console.log('Loading transactions from localStorage...');
    
    try {
        const saved = localStorage.getItem('transactions');
        console.log('Raw data from localStorage:', saved);
        
        if (saved) {
            const parsedTransactions = JSON.parse(saved);
            // Проверяем и фильтруем транзакции с некорректными категориями
            // Также конвертируем старые транзакции с полем note в description
            transactions = parsedTransactions.map(transaction => {
                // Конвертируем старый формат в новый
                if (transaction.note !== undefined) {
                    transaction.description = transaction.note;
                    delete transaction.note;
                }
                return transaction;
            }).filter(transaction => {
                const categoryExists = categories[transaction.type]?.some(c => c.id === transaction.category);
                if (!categoryExists) {
                    console.warn('Skipping transaction with invalid category:', transaction);
                }
                return categoryExists;
            });
            console.log('Parsed and filtered transactions:', transactions);
            
            // Сохраняем обновленные транзакции обратно в localStorage
            saveTransactions();
        } else {
            console.log('No saved transactions found');
            transactions = [];
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
        transactions = [];
    }
}

function renderCategories() {
    const categoriesContainer = document.querySelector('.categories-grid');
    categoriesContainer.innerHTML = '';

    // Render income categories section
    const incomeSection = document.createElement('div');
    incomeSection.className = 'category-section income';
    incomeSection.innerHTML = `<h3>${translations[currentLang].income}</h3>`;
    
    const incomeGrid = document.createElement('div');
    incomeGrid.className = 'category-items-grid';

    // Render income categories
    categories.income.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card income';
        categoryCard.innerHTML = `
            <div class="category-content">
                <i class="fas ${category.icon}"></i>
                <span>${category.name[currentLang]}</span>
            </div>
            <div class="category-actions">
                <button class="edit-btn" title="${translations[currentLang].editCategory}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn" title="${translations[currentLang].deleteCategory}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        // Добавляем быстрое добавление транзакции по клику на категорию
        categoryCard.querySelector('.category-content').addEventListener('click', () => {
            showTransactionModal('income', category.id);
        });
        
        // Добавляем обработчики для кнопок редактирования и удаления
        categoryCard.querySelector('.edit-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            editCategory(category);
        });
        
        categoryCard.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteCategory(category.id);
        });
        
        incomeGrid.appendChild(categoryCard);
    });

    // Add "Add Category" button for income
    const addIncomeCategoryCard = document.createElement('div');
    addIncomeCategoryCard.className = 'category-card add-category income';
    addIncomeCategoryCard.innerHTML = `
        <i class="fas fa-plus"></i>
        <span>${translations[currentLang].addCategory}</span>
    `;
    addIncomeCategoryCard.addEventListener('click', () => showAddCategoryModal('income'));
    incomeGrid.appendChild(addIncomeCategoryCard);
    
    incomeSection.appendChild(incomeGrid);
    categoriesContainer.appendChild(incomeSection);

    // Render expense categories section
    const expenseSection = document.createElement('div');
    expenseSection.className = 'category-section expense';
    expenseSection.innerHTML = `<h3>${translations[currentLang].expense}</h3>`;
    
    const expenseGrid = document.createElement('div');
    expenseGrid.className = 'category-items-grid';

    // Render expense categories
    categories.expense.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card expense';
        categoryCard.innerHTML = `
            <div class="category-content">
                <i class="fas ${category.icon}"></i>
                <span>${category.name[currentLang]}</span>
            </div>
            <div class="category-actions">
                <button class="edit-btn" title="${translations[currentLang].editCategory}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn" title="${translations[currentLang].deleteCategory}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        // Добавляем быстрое добавление транзакции по клику на категорию
        categoryCard.querySelector('.category-content').addEventListener('click', () => {
            showTransactionModal('expense', category.id);
        });
        
        // Добавляем обработчики для кнопок редактирования и удаления
        categoryCard.querySelector('.edit-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            editCategory(category);
        });
        
        categoryCard.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteCategory(category.id);
        });
        
        expenseGrid.appendChild(categoryCard);
    });

    // Add "Add Category" button for expense
    const addExpenseCategoryCard = document.createElement('div');
    addExpenseCategoryCard.className = 'category-card add-category expense';
    addExpenseCategoryCard.innerHTML = `
        <i class="fas fa-plus"></i>
        <span>${translations[currentLang].addCategory}</span>
    `;
    addExpenseCategoryCard.addEventListener('click', () => showAddCategoryModal('expense'));
    expenseGrid.appendChild(addExpenseCategoryCard);
    
    expenseSection.appendChild(expenseGrid);
    categoriesContainer.appendChild(expenseSection);
}

function showAddCategoryModal(type) {
    const modalHTML = `
        <div class="modal category-modal active">
            <div class="modal-content">
                <h2>${translations[currentLang].addCategory}</h2>
                <form id="categoryForm">
                    <input type="hidden" name="type" value="${type}">
                    <div class="form-group">
                        <label>${translations[currentLang].categoryName}</label>
                        <input type="text" name="name_en" placeholder="English name" required>
                        <input type="text" name="name_de" placeholder="German name" required>
                        <input type="text" name="name_ru" placeholder="Russian name" required>
                    </div>
                    <div class="form-group">
                        <label>${translations[currentLang].categoryIcon}</label>
                        <select name="icon" required>
                            ${generateIconOptions()}
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn">${translations[currentLang].cancel}</button>
                        <button type="submit" class="save-btn">${translations[currentLang].save}</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const categoryModal = document.querySelector('.category-modal');
    const categoryForm = document.getElementById('categoryForm');

    categoryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(categoryForm);
        
        const newCategory = {
            id: 'category_' + Date.now(),
            name: {
                en: formData.get('name_en'),
                de: formData.get('name_de'),
                ru: formData.get('name_ru')
            },
            icon: formData.get('icon')
        };

        const categoryType = formData.get('type');
        categories[categoryType].push(newCategory);
        
        saveCategories();
        updateUI();
        categoryModal.remove();
    });

    categoryModal.querySelector('.cancel-btn').addEventListener('click', () => {
        categoryModal.remove();
    });
}

// Добавим функцию updateUI
function updateUI() {
    console.log('Updating UI...');
    updateTransactionsList();
    updateBalance();
    renderCategories();
    
    // Обновляем все переводимые элементы
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.dataset.translate;
        element.textContent = translations[currentLang][key] || key;
    });
    
    console.log('UI updated');
}

// Добавляем функцию удаления транзакции
function deleteTransaction(id) {
    console.log('Deleting transaction:', id);
    if (confirm(translations[currentLang].confirmDelete)) {
        transactions = transactions.filter(t => t.id !== id);
        saveTransactions();
        updateUI();
    }
}

// Добавляем функцию для отображения главной страницы
function showHome() {
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    document.querySelector('.home-section').style.display = 'block';
    
    // Обновляем активную кнопку навигации
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === 'home');
    });
}

// Добавляем функцию для отображения раздела отчетов
function showReports() {
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    document.querySelector('.reports-section').style.display = 'block';
    
    // Обновляем активную кнопку навигации
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === 'reports');
    });

    // Отрисовываем карточки отчетов
    const reportsContainer = document.querySelector('.reports-section');
    reportsContainer.innerHTML = `
        <h2 data-translate="reports">${translations[currentLang].reports}</h2>
        <div class="reports-grid">
            <div class="report-card" data-report="daily">
                <i class="fas fa-calendar-day"></i>
                <span data-translate="daily">${translations[currentLang].daily}</span>
            </div>
            <div class="report-card" data-report="weekly">
                <i class="fas fa-calendar-week"></i>
                <span data-translate="weekly">${translations[currentLang].weekly}</span>
            </div>
            <div class="report-card" data-report="monthly">
                <i class="fas fa-calendar-alt"></i>
                <span data-translate="monthly">${translations[currentLang].monthly}</span>
            </div>
            <div class="report-card" data-report="annual">
                <i class="fas fa-calendar"></i>
                <span data-translate="annual">${translations[currentLang].annual}</span>
            </div>
        </div>
    `;

    // Добавляем обработчики для карточек отчетов
    document.querySelectorAll('.report-card').forEach(card => {
        card.addEventListener('click', () => {
            const reportType = card.dataset.report;
            showReport(reportType);
        });
    });
}

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Apply initial language
    setLanguage(currentLang);
    
    // Apply initial theme
    applyTheme();
    
    // Load saved data
    loadTransactions();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Render categories
    renderCategories();
    
    // Update UI elements
    updateTransactionsList();
    updateBalance();
    
    // Show home section by default
    showHome();
}); 